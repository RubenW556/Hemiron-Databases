image: nielsprins/ipsenh-ci

cache:
  untracked: true
  policy: push
  key:
    files:
      - backend/package-lock.json
      - frontend/package-lock.json
  paths:
    - backend/node_modules/
    - frontend/node_modules/

.pull_cached_node_modules:
  cache:
    untracked: true
    key:
      files:
        - backend/package-lock.json
        - frontend/package-lock.json
    policy: pull

stages:
  - setup
  - test
  - build
  - deploy

backend_setup:
  stage: setup
  script:
    - (cd ./backend && npm ci)

frontend_setup:
  stage: setup
  script:
    - (cd ./frontend && npm ci)

npm_audit:
  stage: test
  allow_failure: true
  needs:
    - frontend_setup
    - backend_setup
  extends: .pull_cached_node_modules
  script:
    - (cd ./backend && npm audit)
    - (cd ./frontend && npm audit)

backend_lint:
  stage: test
  needs:
    - backend_setup
  extends: .pull_cached_node_modules
  script:
    - (cd ./backend && npm run lint)

frontend_lint:
  stage: test
  needs:
    - frontend_setup
  extends: .pull_cached_node_modules
  script:
    - (cd ./backend && npm run lint)

backend_test:
  stage: test
  needs:
    - backend_setup
  extends: .pull_cached_node_modules
  script:
    - (cd ./backend && npm run test)

#frontend_test:
#  stage: test
#  needs:
#    - frontend_setup
#  extends: .pull_cached_node_modules
#  script:
#    - (cd ./frontend && npm run test)

backend_build:
  stage: deploy
  image: docker:latest
  needs:
    - backend_lint
    - backend_test
  script:
    - (cd ./backend && docker build -t backend:latest .)
  only:
    - main
